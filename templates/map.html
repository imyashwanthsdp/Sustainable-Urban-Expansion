<!DOCTYPE html>
<html>
<head>
    <title>Live Zone Evaluation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        body { margin:0; padding:0; }
        #map { height: 100vh; }
    </style>
</head>
<body>

<div id="map"></div>

<script>

var map = L.map('map').setView([13.0827, 80.2707], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

var drawControl = new L.Control.Draw({
    draw: {
        polygon: false,
        polyline: false,
        circle: false,
        marker: false,
        circlemarker: false,
        rectangle: true
    },
    edit: { featureGroup: drawnItems }
});
map.addControl(drawControl);

map.on(L.Draw.Event.CREATED, function (event) {

    var layer = event.layer;
    drawnItems.addLayer(layer);

    var bounds = layer.getBounds();

    var zoneData = {
        north: bounds.getNorth(),
        south: bounds.getSouth(),
        east: bounds.getEast(),
        west: bounds.getWest()
    };

    fetch('/predict_zone', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(zoneData)
    })
    .then(res => res.json())
    .then(result => {

        console.log("Backend Response:", result);

        if (result.error) {
            layer.bindPopup("Error: " + result.error).openPopup();
            return;
        }

        let color = "gray";
        if (result.prediction == 2) color = "green";
        else if (result.prediction == 1) color = "orange";
        else color = "red";

        layer.setStyle({ color: color });

        layer.bindPopup(
            "<b>Decision:</b> " + result.decision +
            "<br><b>Sustainability Score:</b> " + result.score +
            "<br><b>Area:</b> " + result.area_km2 + " km²" +
            "<br><b>Road Density:</b> " + result.road_density +
            "<br><b>Population Density:</b> " + result.pop_density +
            "<br><b>Distance to Water:</b> " + result.distance_water + " km"
        ).openPopup();
    });
});

</script>

</body>
</html>